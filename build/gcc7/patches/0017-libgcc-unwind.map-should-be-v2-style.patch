From 90f612b10095b65f1114f5e584521eceb57c55da Mon Sep 17 00:00:00 2001
From: John Levon <john.levon@joyent.com>
Date: Tue, 20 Nov 2018 16:07:51 +0000
Subject: [PATCH 17/17] libgcc-unwind.map should be v2-style

diff -wpruN '--exclude=*.orig' a~/libgcc/config/t-slibgcc-sld a/libgcc/config/t-slibgcc-sld
--- a~/libgcc/config/t-slibgcc-sld	1970-01-01 00:00:00
+++ a/libgcc/config/t-slibgcc-sld	1970-01-01 00:00:00
@@ -8,6 +8,9 @@ ifeq ($(enable_shared),yes)
 
 # Linker mapfile to enforce direct binding to libgcc_s unwinder
 # (PR target/59788).
+
+ifeq ($(with_gnu_ld),yes)
+
 libgcc-unwind.map: libgcc-std.ver
 	@(echo "{";				\
 	for f in `grep _Unwind_ $< | sort`; do	\
@@ -15,6 +18,22 @@ libgcc-unwind.map: libgcc-std.ver
 	done;					\
 	echo "};" ) > $@
 
+else
+
+libgcc-unwind.map: libgcc-std.ver
+	@(echo "# Generated by libgcc/config/t-slibgcc-sld";	\
+	echo;							\
+	echo '$$mapfile_version 2'; 				\
+	echo;							\
+	echo "SYMBOL_SCOPE {";					\
+	echo "    global:";					\
+	for f in `grep _Unwind_ $< | sort`; do			\
+	  echo "	$$f { FLAGS = EXTERN DIRECT };";	\
+	done;							\
+	echo "};" ) > $@
+
+endif
+
 # Copy libgcc-unwind.map to the place where gcc will look for it at build-time.
 install-libgcc-unwind-map-forbuild: libgcc-unwind.map
 	dest=$(gcc_objdir)/tmp$$$$-$<; \
